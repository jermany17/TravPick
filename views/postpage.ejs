<%- include("include/_header") %>

    <div class="postpage-container">
        <!-- í—¤ë” ì„¹ì…˜ (íƒ€ì´í‹€, ì‘ì„±ì, ë©”íƒ€ ì •ë³´) -->
        <div class="postpage-header">
            <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ì¶”ê°€ -->
            <div class="like-container">
                <div id="like-button" class="like-button">
                    <span id="like-icon" class="material-symbols-outlined">favorite</span>
                    <span id="like-count">0</span>
                </div>
            </div>

            <h1 id="post-title" class="postpage-title"></h1>
            <div id="post-meta" class="postpage-meta"></div>

            <!-- ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ìˆ˜ì •, ì‚­ì œ) -->
            <div id="post-buttons" class="postpage-buttons" style="display: none;">
                <button id="edit-post" class="postpage-button">ìˆ˜ì •</button>
                <button id="delete-post" class="postpage-button">ì‚­ì œ</button>
            </div>
        </div>

        <!-- ë³¸ë¬¸ ë‚´ìš© (ì´ë¯¸ì§€ & ê¸€) -->
        <div id="post-content" class="postpage-content"></div>
    </div>

    <script>
        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜ ì¶”ê°€ (yyyy. MM. dd. HH:mm:ss)
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const yyyy = date.getFullYear();
            const MM = String(date.getMonth() + 1).padStart(2, "0");
            const dd = String(date.getDate()).padStart(2, "0");
            const HH = String(date.getHours()).padStart(2, "0");
            const mm = String(date.getMinutes()).padStart(2, "0");

            return `${yyyy}. ${MM}. ${dd}. ${HH}:${mm}`;
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const postId = "<%= postId.toString() %>"; // ì„œë²„ì—ì„œ ì „ë‹¬í•œ postId ê°’ ì‚¬ìš©
            const loggedInUserId = "<%= loggedInUserId ? loggedInUserId.toString() : '' %>";

            try {
                const response = await fetch(`/post/${postId}`);
                if (!response.ok) {
                    throw new Error("ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                const post = await response.json();

                // ì œëª© ë° ì‘ì„±ì ì„¤ì •
                document.getElementById("post-title").innerHTML = `${post.title} <span class="postpage-author">by ${post.userName}</span>`;

                // ë©”íƒ€ ë°ì´í„° ì„¤ì •
                document.getElementById("post-meta").innerHTML = `
                <span>${post.country}</span> | 
                <span>${post.classify}</span> | 
                <span>${formatDateTime(post.createAt)}</span>
                `;

                // ì½˜í…ì¸  ì¶”ê°€ (ê¸€ê³¼ ì´ë¯¸ì§€ êµ¬ë¶„)
                const contentContainer = document.getElementById("post-content");
                const imageUrls = []; // ì´ë¯¸ì§€ URL ì €ì¥ ë°°ì—´

                post.contents.forEach(content => {
                    if (content.startsWith("https")) {
                        // ì´ë¯¸ì§€ URL ì €ì¥
                        imageUrls.push(content);

                        // ì´ë¯¸ì§€ì¼ ê²½ìš°
                        const imgElement = document.createElement("img");
                        imgElement.src = content;
                        imgElement.className = "postpage-image";
                        contentContainer.appendChild(imgElement);
                    } else {
                        // ê¸€ì¼ ê²½ìš°
                        const textElement = document.createElement("p");
                        textElement.className = "postpage-text";
                        textElement.textContent = content;
                        contentContainer.appendChild(textElement);
                    }
                });

                console.log("postId:", postId);  // ğŸ›  postId ê°’ í™•ì¸
                console.log("loggedInUserId:", loggedInUserId);  // ğŸ›  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID í™•ì¸
                console.log("postuserId: ", post.userId.toString());

                // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì˜ ì‘ì„±ìì™€ ê°™ë‹¤ë©´ ë²„íŠ¼ í‘œì‹œ
                if (loggedInUserId && loggedInUserId === post.userId.toString()) {
                    document.getElementById("post-buttons").style.display = "flex";
                }

                // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById("edit-post").addEventListener("click", function () {
                    window.location.href = `/changepost/${postId}`;
                });

                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById("delete-post").addEventListener("click", async function () {
                    if (confirm("ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        try {
                            // ëª¨ë“  ì´ë¯¸ì§€ ì‚­ì œ ìš”ì²­ ë³´ë‚´ê¸°
                            const deleteImageRequests = imageUrls.map(url => {
                                return fetch(`/s3/delete?fileUrl=${encodeURIComponent(url)}`, {
                                    method: "DELETE"
                                });
                            });

                            // ì´ë¯¸ì§€ ì‚­ì œ ê²°ê³¼ í™•ì¸
                            const deleteImageResponses = await Promise.all(deleteImageRequests);
                            const allDeleted = deleteImageResponses.every(response => response.ok);

                            if (!allDeleted) {
                                throw new Error("ì¼ë¶€ ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨");
                            }

                            // ëª¨ë“  ì´ë¯¸ì§€ê°€ ì‚­ì œëœ í›„, ê²Œì‹œë¬¼ ì‚­ì œ ìš”ì²­
                            const deleteResponse = await fetch(`/post/${postId}`, {
                                method: "DELETE"
                            });

                            if (!deleteResponse.ok) {
                                throw new Error("ê²Œì‹œë¬¼ ì‚­ì œ ì‹¤íŒ¨");
                            }

                            alert("ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            window.location.href = `/countrypage/${post.country}/${post.classify}`;
                        } catch (error) {
                            console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
                            alert("ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                });

            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                document.getElementById("post-content").innerHTML = "<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
            }
        });

        document.addEventListener("DOMContentLoaded", async function () {
            const postId = "<%= postId.toString() %>";
            const loggedInUserId = "<%= loggedInUserId ? loggedInUserId.toString() : '' %>";

            const likeButton = document.getElementById("like-button");
            const likeIcon = document.getElementById("like-icon");
            const likeCountElement = document.getElementById("like-count");

            try {
                // ì¢‹ì•„ìš” ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
                const likeResponse = await fetch(`/post/${postId}/like`);
                if (!likeResponse.ok) {
                    throw new Error("ì¢‹ì•„ìš” ê°œìˆ˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                const likeData = await likeResponse.json();
                likeCountElement.textContent = likeData.likeCount;

                // ë¡œê·¸ì¸ëœ ê²½ìš° ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
                if (loggedInUserId) {
                    const postResponse = await fetch(`/post/${postId}`);
                    if (!postResponse.ok) {
                        throw new Error("ê²Œì‹œë¬¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    const postData = await postResponse.json();

                    // ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ë‹¤ë©´ ë¹¨ê°„ìƒ‰ ì±„ìš°ê¸°
                    if (postData.likes.includes(loggedInUserId)) {
                        likeButton.classList.add("liked");
                    }

                    // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    likeButton.addEventListener("click", async function () {
                        try {
                            const toggleResponse = await fetch(`/post/${postId}/${loggedInUserId}/like`, {
                                method: "POST"
                            });

                            if (!toggleResponse.ok) {
                                throw new Error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨");
                            }

                            const updatedLikeData = await (await fetch(`/post/${postId}/like`)).json();
                            likeCountElement.textContent = updatedLikeData.likeCount;

                            // ì¢‹ì•„ìš” í† ê¸€ (ì±„ì›Œì§/ë¹„ì›Œì§)
                            likeButton.classList.toggle("liked");
                        } catch (error) {
                            console.error("ì¢‹ì•„ìš” ì˜¤ë¥˜:", error);
                        }
                    });
                }
            } catch (error) {
                console.error("ì¢‹ì•„ìš” ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
            }
        });
    </script>

    <%- include("include/_footer") %>
