<%- include("include/_header") %>

    <div class="postpage-container">
        <!-- í—¤ë” ì„¹ì…˜ (íƒ€ì´í‹€, ì‘ì„±ì, ë©”íƒ€ ì •ë³´) -->
        <div class="postpage-header">
            <h1 id="post-title" class="postpage-title"></h1>
            <div id="post-meta" class="postpage-meta"></div>

            <!-- ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ìˆ˜ì •, ì‚­ì œ) -->
            <div id="post-buttons" class="postpage-buttons" style="display: none;">
                <button id="edit-post" class="postpage-button">ìˆ˜ì •</button>
                <button id="delete-post" class="postpage-button">ì‚­ì œ</button>
            </div>
        </div>

        <!-- ë³¸ë¬¸ ë‚´ìš© (ì´ë¯¸ì§€ & ê¸€) -->
        <div id="post-content" class="postpage-content"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const postId = "<%= postId.toString() %>"; // ì„œë²„ì—ì„œ ì „ë‹¬í•œ postId ê°’ ì‚¬ìš©
            const loggedInUserId = "<%= loggedInUserId ? loggedInUserId.toString() : '' %>";

            try {
                const response = await fetch(`/post/${postId}`);
                if (!response.ok) {
                    throw new Error("ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                const post = await response.json();

                // ì œëª© ë° ì‘ì„±ì ì„¤ì •
                document.getElementById("post-title").innerHTML = `${post.title} <span class="postpage-author">by ${post.userName}</span>`;

                // ë©”íƒ€ ë°ì´í„° ì„¤ì •
                document.getElementById("post-meta").innerHTML = `
                <span>${post.country}</span> | 
                <span>${post.classify}</span> | 
                <span>${new Date(post.createAt).toLocaleDateString()}</span>
                `;

                // ì½˜í…ì¸  ì¶”ê°€ (ê¸€ê³¼ ì´ë¯¸ì§€ êµ¬ë¶„)
                const contentContainer = document.getElementById("post-content");
                post.contents.forEach(content => {
                    if (content.startsWith("http")) {
                        // ì´ë¯¸ì§€ì¼ ê²½ìš°
                        const imgElement = document.createElement("img");
                        imgElement.src = content;
                        imgElement.className = "postpage-image";
                        contentContainer.appendChild(imgElement);
                    } else {
                        // ê¸€ì¼ ê²½ìš°
                        const textElement = document.createElement("p");
                        textElement.className = "postpage-text";
                        textElement.textContent = content;
                        contentContainer.appendChild(textElement);
                    }
                });

                console.log("postId:", postId);  // ğŸ›  postId ê°’ í™•ì¸
                console.log("loggedInUserId:", loggedInUserId);  // ğŸ›  ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID í™•ì¸
                console.log("postuserId: ", post.userId.toString());
                // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì˜ ì‘ì„±ìì™€ ê°™ë‹¤ë©´ ë²„íŠ¼ í‘œì‹œ
                if (loggedInUserId && loggedInUserId === post.userId.toString()) {
                    document.getElementById("post-buttons").style.display = "flex";
                }

                // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById("edit-post").addEventListener("click", function () {
                    window.location.href = `/changepost/${postId}`;
                });

                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById("delete-post").addEventListener("click", async function () {
                    if (confirm("ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        try {
                            const deleteResponse = await fetch(`/post/${postId}`, {
                                method: "DELETE"
                            });

                            if (!deleteResponse.ok) {
                                throw new Error("ê²Œì‹œë¬¼ ì‚­ì œ ì‹¤íŒ¨");
                            }

                            alert("ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            window.location.href = "/";
                        } catch (error) {
                            console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
                            alert("ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                });

            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                document.getElementById("post-content").innerHTML = "<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
            }
        });
    </script>

    <%- include("include/_footer") %>
